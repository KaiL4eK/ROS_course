# Навигация роботов

Весь стек программ, необходимый для навигации в ROS реализован в пакете move_base. 
В этой части постараемся разобраться из чего он состоит, как работает и как его настраивать.
Но в начале разберемся, что теоретически нужно для эффективной навигиции.

### Что такое навигации?
Во-первых, следует определить, что здесь будем понимать под навигацией. Навигация - это область исследования, 
которая фокусируется на процессе мониторинга и управления перемещением корабля или транспортного средства из одного места в другое (с)Wiki. 
Из такого определения можно сразу же сделать два выводы. Навигация занимается лишь вопросом перемещения из одной точки вдругу, включая поиск пути. 
При этом она игнорирует вопросы, связанные с определением положения и картографирование.
Из этого следует, что для того, чтобы запустить навигацию, первоначально необходимо поднять SLAM и затем предоставить карту и текущее положение в навигационный стек.

### Из чего состоит навигация?
Основной составляющей навигации являются алгоритмы поиска пути. Они отвечают за то, что бы навигационный стек непосредственно выполнял свою прямую функцию.
В уже устоявшемся представлении поиск пути осуществляется в два этапа: глобальное планирование и локальное планирование.

Глобальный планировщик отвечает за генерацию плана движения от стартовой точки до конечной. И теоретически может вообще не обновляться в процессе движения, либо обновляться, но очень редко. 
Передлокальным планировщиком же стоит цель безопасно провести робота через небольшие локальные участки метсности, избегая периодически возникающие препятствия. 
То есть по сути в определенный момент времени выделяется некоторая область на карте, внутрик которой сокальный планировщик строит путь от текущего положения робота к точке глобального плана на границе локальной карты. И этот процесс повторяется довольно часто (обоычно 5-10 Гц).

Часто бывает так, что использование в чистом виде нарисованной карты системой картографирования (SLAM) не достаточно.
Для того, чтобы робот мог безопасно объехать препятствие, необходимо учесть его габариты и задать безопасное расстрояние до препятствия. В этом помогаю карты стоимости (costmap), которые также как и планировщики бывают локальными и глобальными, и соответственно образуются пары: локальный планировщик строит путь на локальной карте, а глобальный на глобальной.  

### Настройка move_base
В целом навигационный пакет имеет слишком большое количество параметров. Поэтому определять их все в launch-файле не рекомендуется. Для этого существуюм конфигурационные файлы с расширением `*.yaml`. Для использования таких файлов используется следующий синтаксис:
```yaml
node_name:
 param_name: value
 group_param:
  param_name: value
```
Для загрузки конфигурационного файла внутри инициализации ноды нужна следующая команда:
```xml
<rosparam file="$(find <package_name>)/.../path/.../<file_name>.yaml" command="load" ns="<namespace_name>" />
```
### Основные параметры 
К основным параметрам move_base относятся:
* base_global_planner - тип глобального планировщика 
* base_local_planner - тип локального планировщика 
* controller_frequency - частота работы навигации и отправки команд роботу
* controller_patience - время ожидания адекватных данных управления до очестки карты
* planner_frequency - частота одновления глобального палана
* planner_patience - время ожидания поиска пути до очистки карты
* oscillation_timeout - время восстановления данных (карты)
* oscillation_distance - расстояние которое нужно пройти для восстановления

К основным параметрам costmap относятся:
* plugins (static_layer, obstacle_layer and inflation_layer) - слои работы карты. Обычно для глобальной используют `static_layer and inflation_layer`, а для локальной `obstacle_layer and inflation_layer`. Запись будет иметь следующий вид:
```yaml
plugins:
 - {name: obstacles,                 type: "costmap_2d::ObstacleLayer"}
 - {name: inflation,                 type: "costmap_2d::InflationLayer"}
```
* global_frame - глобальны фрейм
* robot_base_frame - фрейм робота
* update_frequency - частота обновления карты
* publish_frequency - частота публикации карты
* width - ширина карты
* height - высота карты
* resolution - разрешение карты
* footprint: [[-0.325, -0.325], [-0.325, 0.325], [0.325, 0.325], [0.46, 0.0], [0.325, -0.325]] - форма робота на плоскости
или
* robot_radius: 0.25 - круглая форма робота на плоскости
* obstacle_range: 6.5 - дальностьт обнаружение препятствий
* raytrace_range: 7.0 - дальность работы лучей
* obstacles: - параметры препятствий
   observation_sources: base_scan - источник препятствий  (может быть несколько)

   laser_frame:
    data_type: LaserScan
    clearing: true
    marking: true
    topic: scan
    inf_is_valid: true

  inflation:
   inflation_radius: 0.1 - до какого размера расширяется препятствие на карте

При создании локальной и глобальной карты они должны находиться на разных namespace (global_costmap и local_costmap). Для каждой карты параметры инийциализируются отдельно.

С планировщиками дела обстоят несколько сложнее из-за их большого разнообразия. Поэтому рассмотрим пример настройки одного из них `dwa_local_planner/DWAPlannerROS`:
* acc_lim_x, acc_lim_y, acc_lim_th, max_vel_trans, min_vel_trans, max_vel_x, min_vel_x, max_vel_y, min_vel_y, max_rot_vel, min_rot_vel - ограничения на максимальные/минимальные скорости/ускорения
* yaw_goal_tolerance, xy_goal_tolerance - допустимая отклонение от цели
* так же есть еще другие параметры, но для минимального импользования этих будет более чем достаточно (и то не обязательно все).
За более полной информацией как всегда следует обращатьна официальный сайт ROS, например, http://wiki.ros.org/dwa_local_planner?distro=noetic.
